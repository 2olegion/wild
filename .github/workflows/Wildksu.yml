name: Build WildKSU-Next + SuSFS

on:
  workflow_dispatch:
  push:
    branches:
      - wild        # oder dein Build-Branch

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ARCH: arm64
      SUBARCH: arm64
      # Passe Toolchain an:
      CLANG_URL: https://github.com/ZyCromerZ/Clang.git
      CLANG_BRANCH: main
      KERNEL_DEFCONFIG: your_defconfig_here      # z.B. vendor/yourdevice_defconfig
      KERNEL_IMG_NAME: Image.gz-dtb             # oder Image, Image-dtb etc.

    steps:
      - name: Checkout kernel source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc bison flex build-essential \
            ccache git zip unzip libssl-dev wget python3 \
            lz4 zstd

      - name: Fetch Clang toolchain
        run: |
          git clone --depth=1 "$CLANG_URL" -b "$CLANG_BRANCH" clang
          echo "$PWD/clang/bin" >> $GITHUB_PATH

      - name: Integrate Wild_KSU + SuSFS
        run: |
          # Script von Wild_KSU aufrufen, im Kernel-Root
          curl -LSs "https://raw.githubusercontent.com/WildKernels/KernelSU-Next/refs/heads/wild/kernel/setup.sh" \
            | bash -s wild-susfs
        shell: bash

      - name: Configure kernel
        run: |
          export ARCH=$ARCH
          export SUBARCH=$SUBARCH
          export PATH="$PWD/clang/bin:$PATH"
          # ggf. CROSS_COMPILE anpassen, wenn dein Tree GCC erwartet
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CROSS_COMPILE_COMPAT=arm-linux-gnueabi-
          make O=out $KERNEL_DEFCONFIG

      - name: Build kernel
        run: |
          export ARCH=$ARCH
          export SUBARCH=$SUBARCH
          export PATH="$PWD/clang/bin:$PATH"
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CROSS_COMPILE_COMPAT=arm-linux-gnueabi-
          make -j$(nproc) O=out

      - name: Upload kernel artifact
        uses: actions/upload-artifact@v4
        with:
          name: wildksu-next-susfs-kernel
          path: |
            out/arch/arm64/boot/${{ env.KERNEL_IMG_NAME }}
            out/arch/arm64/boot/dts/**/*
